<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lab Dashboard TV Mode</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;900&display=swap"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />

  <style>
    :root {
      --bg-color: #000000;
      --card-bg: #1c1c1e;
      --accent: #0a84ff;
      --text-main: #ffffff;
      --text-muted: #98989d;
      --border-radius: 12px;
      
      --success: #30d158;
      --warning: #ff9f0a;
      --danger: #ff453a;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Roboto", sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden; /* 防止捲動 */
      display: flex;
      flex-direction: column;
    }

    /* === Header === */
    header {
      flex: 0 0 auto; /* 固定高度 */
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color: #111;
      border-bottom: 1px solid #333;
    }
    .clock { font-size: 1.5rem; font-weight: 700; color: var(--accent); }
    .weather { font-size: 1.1rem; color: var(--text-muted); }

    /* === Resizer Handles === */
    .resizer {
      flex: 0 0 8px; /* 拖曳條厚度 */
      background: #222;
      cursor: row-resize;
      display: flex;
      justify-content: center;
      align-items: center;
      transition: background 0.2s;
      z-index: 10;
    }
    .resizer:hover, .resizer.dragging {
      background: var(--accent);
    }
    .resizer::after {
      content: '';
      width: 40px;
      height: 4px;
      background: #555;
      border-radius: 2px;
    }

    /* === Main Sections === */
    /* 這些 section 的高度現在由 inline style (flex-basis) 控制 */
    section {
      padding: 10px 20px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    h2 {
      font-size: 1.2rem;
      margin-bottom: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      flex: 0 0 auto;
    }

    /* === Notice === */
    #notice-area {
      width: 100%;
      height: 100%;
      background: transparent;
      border: none;
      color: var(--warning);
      font-size: 1.8rem;
      font-weight: 700;
      resize: none;
      outline: none;
      text-align: center;
      line-height: 1.4;
    }

    /* === Bench Rotation === */
    .bench-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 15px;
      height: 100%;
      overflow-y: auto;
    }
    .bench-card {
      background: var(--card-bg);
      padding: 10px;
      border-radius: var(--border-radius);
      border-left: 4px solid var(--accent);
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .bench-name { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 4px; }
    .bench-staff { font-size: 1.2rem; font-weight: 700; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    /* === Kanban === */
    #kanban-section {
      flex: 1 1 auto; /* Kanban 自動填滿剩餘空間 */
      min-height: 0; /* 允許 flex child 縮小 */
    }
    
    .kanban-board {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 15px;
      height: 100%;
      min-height: 0; /* 重要：讓 grid 內容可以捲動 */
    }

    .kanban-col {
      background: var(--card-bg);
      border-radius: var(--border-radius);
      padding: 10px;
      display: flex;
      flex-direction: column;
      height: 100%;
      overflow: hidden;
    }

    .col-header {
      padding-bottom: 10px;
      border-bottom: 1px solid #333;
      margin-bottom: 10px;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .col-header.todo { color: var(--text-muted); }
    .col-header.progress { color: var(--accent); }
    .col-header.done { color: var(--success); }

    .task-list {
      flex: 1;
      overflow-y: auto;
      padding-right: 5px;
    }
    
    .task-card {
      background: #2c2c2e;
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 8px;
      font-size: 1rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

  <!-- 1. Header -->
  <header>
    <div class="clock" id="clock">00:00</div>
    <div class="weather" id="weather">Loading weather...</div>
  </header>

  <!-- 2. Notice Section (Resizable) -->
  <section id="notice-section" style="flex-basis: 15%;">
    <h2>Notice Board</h2>
    <textarea id="notice-area" readonly></textarea>
  </section>

  <!-- Resizer 1 -->
  <div class="resizer" id="resizer-1"></div>

  <!-- 3. Rotation Section (Resizable) -->
  <section id="rotation-section" style="flex-basis: 20%;">
    <h2>Bench Rotation</h2>
    <div class="bench-grid" id="bench-container">
      <!-- Benches injected via JS -->
    </div>
  </section>

  <!-- Resizer 2 -->
  <div class="resizer" id="resizer-2"></div>

  <!-- 4. Kanban Section (Fills Remaining) -->
  <section id="kanban-section">
    <div class="kanban-board">
      <div class="kanban-col">
        <div class="col-header todo">To Do <span id="count-todo">0</span></div>
        <div class="task-list" id="list-todo"></div>
      </div>
      <div class="kanban-col">
        <div class="col-header progress">In Progress <span id="count-progress">0</span></div>
        <div class="task-list" id="list-progress"></div>
      </div>
      <div class="kanban-col">
        <div class="col-header done">Done <span id="count-done">0</span></div>
        <div class="task-list" id="list-done"></div>
      </div>
    </div>
  </section>

  <script>
    const API_URL = "/.netlify/functions/dashboard-state";
    const benchList = ["Hematology", "Cobas", "Cytology", "Immulite", "RIA", "Receiving", "Libero"];
    
    // DOM Elements
    const noticeSection = document.getElementById('notice-section');
    const rotationSection = document.getElementById('rotation-section');
    const noticeArea = document.getElementById('notice-area');
    const benchContainer = document.getElementById('bench-container');
    const benchSelects = {}; 
    let currentState = null;

    // Mock Data for Demo/Preview environment (when backend is unreachable)
    const MOCK_STATE = {
        notice: "⚠ Demo Mode: Backend unreachable in preview. Displaying sample data.",
        benches: {
            "Hematology": "Alice",
            "Cobas": "Bob",
            "Cytology": "Carol",
            "Immulite": "--",
            "RIA": "Dave",
            "Receiving": "Eve",
            "Libero": "--"
        },
        kanban: {
            "list-todo": ["Check reagents", "Call service", "Weekly QC"],
            "list-progress": ["Stat spin"],
            "list-done": ["Morning maintenance", "Shift report"]
        },
        layout: {
            noticePercent: 15,
            rotationPercent: 20
        }
    };

    // --- 1. Resizer Logic ---
    function setupResizers() {
      const r1 = document.getElementById('resizer-1');
      const r2 = document.getElementById('resizer-2');
      
      makeResizable(r1, noticeSection);
      makeResizable(r2, rotationSection);
    }

    function makeResizable(resizer, prevSection) {
      let startY, startHeight, totalHeight;

      const onMouseDown = (e) => {
        startY = e.clientY;
        const rect = prevSection.getBoundingClientRect();
        startHeight = rect.height;
        // Calculate total available height of the container to figure out %
        totalHeight = document.body.clientHeight; 
        
        resizer.classList.add('dragging');
        document.addEventListener('mousemove', onMouseMove);
        document.addEventListener('mouseup', onMouseUp);
      };

      const onMouseMove = (e) => {
        const dy = e.clientY - startY;
        const newHeightPx = startHeight + dy;
        // Convert to percentage
        const newHeightPercent = (newHeightPx / totalHeight) * 100;
        
        // Safety limits
        if(newHeightPercent > 5 && newHeightPercent < 60) {
            prevSection.style.flexBasis = `${newHeightPercent}%`;
        }
      };

      const onMouseUp = () => {
        resizer.classList.remove('dragging');
        document.removeEventListener('mousemove', onMouseMove);
        document.removeEventListener('mouseup', onMouseUp);
        
        // Save new layout to server
        saveCurrentLayout();
      };

      resizer.addEventListener('mousedown', onMouseDown);
    }

    async function saveCurrentLayout() {
        if(!currentState) return;

        // Get current percentages from DOM
        const totalH = document.body.clientHeight;
        const noticeH = noticeSection.getBoundingClientRect().height;
        const rotationH = rotationSection.getBoundingClientRect().height;

        const layout = {
            noticePercent: (noticeH / totalH) * 100,
            rotationPercent: (rotationH / totalH) * 100
        };
        
        // Merge with current state and save locally first (optimistic UI)
        currentState = { ...currentState, layout };
        
        try {
            // Attempt to save to backend
            const res = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(currentState),
            });
            if(res.ok) {
                console.log("Layout saved to backend");
            } else {
                throw new Error("Backend save failed");
            }
        } catch(e) {
            console.warn("Demo Mode: Layout saved locally only (Backend unreachable)");
        }
    }

    // --- 2. Clock & Weather ---
    function updateClock() {
      const now = new Date();
      document.getElementById('clock').innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    setInterval(updateClock, 1000);
    updateClock();

    async function fetchWeather() {
      // Guelph coordinates
      try {
        const res = await fetch("https://api.open-meteo.com/v1/forecast?latitude=43.54&longitude=-80.25&current_weather=true");
        const data = await res.json();
        const t = Math.round(data.current_weather.temperature);
        document.getElementById('weather').innerText = `Guelph: ${t}°C`;
      } catch (e) {
        document.getElementById('weather').innerText = "Weather Unavailable";
      }
    }
    fetchWeather();
    setInterval(fetchWeather, 600000); // 10 mins

    // --- 3. Rendering ---
    function initBenches() {
      benchContainer.innerHTML = "";
      benchList.forEach(b => {
        const div = document.createElement('div');
        div.className = 'bench-card';
        div.innerHTML = `
          <div class="bench-name">${b}</div>
          <div class="bench-staff" id="bench-${b}">--</div>
        `;
        benchContainer.appendChild(div);
      });
    }

    function renderKanban(kanbanData) {
      if (!kanbanData) return;
      ['todo', 'progress', 'done'].forEach(status => {
         const listId = `list-${status}`;
         const countId = `count-${status}`;
         const container = document.getElementById(listId);
         const items = kanbanData[listId] || [];
         
         container.innerHTML = items.map(t => `<div class="task-card">${t}</div>`).join('');
         document.getElementById(countId).innerText = items.length;
      });
    }

    function applyState(state) {
      if(!state) return;
      currentState = state;

      // 1. Layout (Flex Basis)
      if(state.layout) {
          if(state.layout.noticePercent) 
            noticeSection.style.flexBasis = `${state.layout.noticePercent}%`;
          if(state.layout.rotationPercent)
            rotationSection.style.flexBasis = `${state.layout.rotationPercent}%`;
      }

      // 2. Notice
      noticeArea.value = state.notice || "";

      // 3. Benches
      if(state.benches) {
          benchList.forEach(b => {
              const el = document.getElementById(`bench-${b}`);
              if(el) el.innerText = state.benches[b] || "--";
          });
      }

      // 4. Kanban
      renderKanban(state.kanban);
    }

    // --- 4. Data Loop ---
    async function loop() {
      try {
        // Attempt to fetch from backend
        // This will fail in Code Preview (Blob URL)
        const res = await fetch(API_URL);
        if(res.ok) {
            const data = await res.json();
            applyState(data);
        } else {
             throw new Error("Backend returned status " + res.status);
        }
      } catch(e) { 
          // Fallback to Mock Data if backend is unreachable (Preview Mode)
          // 只在第一次載入失敗時套用 Mock Data，避免覆蓋使用者的本地操作
          if(!currentState) {
              console.warn("Backend unavailable, loading demo data.");
              applyState(MOCK_STATE);
          }
      }
      setTimeout(loop, 5000);
    }

    // Start
    initBenches();
    setupResizers();
    loop();

  </script>
</body>
</html>