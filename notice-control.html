<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Lab Dashboard Control</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 20px 15px;
            color: #333;
        }

        .control-panel {
            background-color: #fff;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        h2 { text-align: center; color: #2c3e50; margin-top: 0; }

        .control-group {
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }

        input[type="text"], textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        textarea { height: 80px; resize: vertical; }

        /* Bench Grid */
        .bench-inputs {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        @media (min-width: 600px) {
            .bench-inputs { grid-template-columns: 1fr 1fr; }
        }

        /* Layout Sliders */
        .slider-container {
            margin-bottom: 15px;
        }
        .slider-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }
        input[type=range] {
            width: 100%;
            height: 8px;
            background: #d3d3d3;
            outline: none;
            border-radius: 4px;
            -webkit-appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #3498db;
            cursor: pointer;
            border-radius: 50%;
        }

        /* Kanban Simple Edit */
        .kanban-edit-row {
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: #f9f9f9;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .k-title { font-weight: bold; font-size: 0.9rem; color: #777; }

        /* Buttons */
        .actions { display: flex; gap: 10px; margin-top: 20px; }
        button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
        }
        #save-btn { background-color: #2ecc71; color: white; }
        #refresh-btn { background-color: #95a5a6; color: white; }

        #status { text-align: center; margin-bottom: 15px; font-weight: 500; min-height: 24px; }
        .success { color: #27ae60; }
        .error { color: #c0392b; }
    </style>
</head>
<body>

    <div class="control-panel">
        <h2>Dashboard Control</h2>
        <div id="status">Loading...</div>

        <!-- 1. Notice -->
        <div class="control-group">
            <label>Notice Board</label>
            <textarea id="notice-text" placeholder="Announcement..."></textarea>
        </div>

        <!-- 2. Bench Rotation -->
        <div class="control-group">
            <label>Staff Rotation</label>
            <div class="bench-inputs" id="bench-inputs">
                <!-- JS Generated -->
            </div>
        </div>

        <!-- 3. Layout Sliders (NEW) -->
        <div class="control-group">
            <label>Display Layout Adjustments (Slide to Resize)</label>
            
            <div class="slider-container">
                <div class="slider-label">
                    <span>Notice Area Height</span>
                    <span id="val-notice">15%</span>
                </div>
                <input type="range" id="rng-notice" min="5" max="50" step="1" value="15">
            </div>

            <div class="slider-container">
                <div class="slider-label">
                    <span>Bench Rotation Height</span>
                    <span id="val-rotation">20%</span>
                </div>
                <input type="range" id="rng-rotation" min="5" max="60" step="1" value="20">
            </div>
            
            <div style="text-align: right; font-size: 0.85rem; color: #888;">
                Remaining space is for Kanban.
            </div>
        </div>

        <!-- 4. Kanban Quick Edit (Simplified for now) -->
        <div class="control-group">
            <label>Kanban Tasks (Comma separated for quick add)</label>
            <div class="kanban-edit-row">
                <span class="k-title">To Do</span>
                <input type="text" id="k-todo" placeholder="Task 1, Task 2...">
            </div>
            <div class="kanban-edit-row">
                <span class="k-title">In Progress</span>
                <input type="text" id="k-progress" placeholder="...">
            </div>
            <div class="kanban-edit-row">
                <span class="k-title">Done</span>
                <input type="text" id="k-done" placeholder="...">
            </div>
        </div>

        <div class="actions">
            <button id="save-btn">Save Changes</button>
            <button id="refresh-btn">Refresh</button>
        </div>
    </div>

    <script>
        const API_ENDPOINT = '/.netlify/functions/dashboard-state';
        const benchesList = ["Hematology", "Cobas", "Cytology", "Immulite", "RIA", "Receiving", "Libero"];

        // Elements
        const elNotice = document.getElementById('notice-text');
        const divBenches = document.getElementById('bench-inputs');
        const rngNotice = document.getElementById('rng-notice');
        const rngRotation = document.getElementById('rng-rotation');
        const valNotice = document.getElementById('val-notice');
        const valRotation = document.getElementById('val-rotation');
        const kTodo = document.getElementById('k-todo');
        const kProgress = document.getElementById('k-progress');
        const kDone = document.getElementById('k-done');
        const btnSave = document.getElementById('save-btn');
        const btnRefresh = document.getElementById('refresh-btn');
        const elStatus = document.getElementById('status');

        let currentState = null;

        // --- Helpers ---
        function setStatus(msg, type) {
            elStatus.textContent = msg;
            elStatus.className = type;
            if(type === 'success') setTimeout(() => elStatus.textContent = '', 3000);
        }

        // --- Sliders UI ---
        function updateSliderLabels() {
            valNotice.textContent = rngNotice.value + '%';
            valRotation.textContent = rngRotation.value + '%';
        }
        rngNotice.addEventListener('input', updateSliderLabels);
        rngRotation.addEventListener('input', updateSliderLabels);

        // --- Build Bench UI ---
        function buildBenchUI() {
            divBenches.innerHTML = '';
            benchesList.forEach(bench => {
                const wrap = document.createElement('div');
                const lbl = document.createElement('div');
                lbl.style.fontSize = '0.85rem';
                lbl.style.marginBottom = '4px';
                lbl.textContent = bench;
                
                const inp = document.createElement('input');
                inp.type = 'text';
                inp.dataset.bench = bench;
                inp.placeholder = 'Staff Name';
                
                wrap.appendChild(lbl);
                wrap.appendChild(inp);
                divBenches.appendChild(wrap);
            });
        }
        buildBenchUI();

        // --- Data Logic ---
        async function loadData() {
            setStatus('Loading...', '');
            try {
                const res = await fetch(`${API_ENDPOINT}?t=${Date.now()}`);
                if(!res.ok) throw new Error('Fetch failed');
                currentState = await res.json();
                populateUI(currentState);
                setStatus('Ready', 'success');
            } catch(e) {
                setStatus('Error loading data', 'error');
            }
        }

        function populateUI(data) {
            if(!data) return;
            
            // Notice
            elNotice.value = data.notice || '';

            // Benches
            const benchInputs = divBenches.querySelectorAll('input');
            benchInputs.forEach(inp => {
                const name = inp.dataset.bench;
                if(data.benches && data.benches[name]) {
                    inp.value = data.benches[name] === '-- Select --' ? '' : data.benches[name];
                }
            });

            // Layout
            if(data.layout) {
                rngNotice.value = data.layout.noticePercent || 15;
                rngRotation.value = data.layout.rotationPercent || 20;
                updateSliderLabels();
            }

            // Kanban (Arrays to Comma String)
            if(data.kanban) {
                kTodo.value = (data.kanban['list-todo'] || []).join(', ');
                kProgress.value = (data.kanban['list-progress'] || []).join(', ');
                kDone.value = (data.kanban['list-done'] || []).join(', ');
            }
        }

        async function saveData() {
            setStatus('Saving...', '');
            btnSave.disabled = true;

            // Prepare Benches
            const benches = {};
            divBenches.querySelectorAll('input').forEach(inp => {
                benches[inp.dataset.bench] = inp.value.trim() || '-- Select --';
            });

            // Prepare Kanban (String to Array)
            const parseKanban = (str) => str.split(',').map(s => s.trim()).filter(s => s);
            const kanban = {
                'list-todo': parseKanban(kTodo.value),
                'list-progress': parseKanban(kProgress.value),
                'list-done': parseKanban(kDone.value)
            };

            const payload = {
                notice: elNotice.value,
                benches: benches,
                kanban: kanban,
                layout: {
                    noticePercent: parseInt(rngNotice.value),
                    rotationPercent: parseInt(rngRotation.value)
                }
            };

            try {
                const res = await fetch(API_ENDPOINT, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                if(!res.ok) throw new Error('Save failed');
                setStatus('Saved!', 'success');
                currentState = payload; // optimist update
            } catch(e) {
                setStatus('Error saving', 'error');
            } finally {
                btnSave.disabled = false;
            }
        }

        btnRefresh.addEventListener('click', loadData);
        btnSave.addEventListener('click', saveData);
        loadData();

    </script>
</body>
</html>